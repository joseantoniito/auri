function init_invoice(a){var b=$('input[name="invoiceid"]').val();""==b||window.location.hash?window.location.hash&&!a&&(a=window.location.hash.substring(1)):(a=b,$('input[name="invoiceid"]').val("")),"undefined"!=typeof a&&""!=a&&($("body").hasClass("small-table")||toggle_small_view(".table-invoices","#invoice"),$('input[name="invoiceid"]').val(a),do_hash_helper(a),$("#invoice").load(admin_url+"invoices/get_invoice_data_ajax/"+a),is_mobile()&&$("html, body").animate({scrollTop:$("#invoice").offset().top+150},600))}function init_estimate(a){var b=$('input[name="estimateid"]').val();""==b||window.location.hash?window.location.hash&&!a&&(a=window.location.hash.substring(1)):(a=b,$('input[name="estimateid"]').val("")),"undefined"!=typeof a&&""!=a&&($("body").hasClass("small-table")||toggle_small_view(".table-estimates","#estimate"),$('input[name="estimateid"]').val(a),do_hash_helper(a),$("#estimate").load(admin_url+"estimates/get_estimate_data_ajax/"+a),is_mobile()&&$("html, body").animate({scrollTop:$("#estimate").offset().top+150},600))}function init_proposal(a){var b=$('input[name="proposal_id"]').val();""==b||window.location.hash?window.location.hash&&!a&&(a=window.location.hash.substring(1)):(a=b,$('input[name="proposal_id"]').val("")),"undefined"!=typeof a&&""!=a&&($("body").hasClass("small-table")||toggle_small_view(".table-proposals","#proposal"),$('input[name="proposal_id"]').val(a),do_hash_helper(a),$("#proposal").load(admin_url+"proposals/get_proposal_data_ajax/"+a),is_mobile()&&$("html, body").animate({scrollTop:$("#proposal").offset().top+150},600))}function clear_billing_and_shipping_details(){for(var a in bs_fields)bs_fields[a].indexOf("country")>-1?$('select[name="'+bs_fields[a]+'"]').selectpicker("val",""):$('input[name="'+bs_fields[a]+'"]').val(""),"billing_country"==bs_fields[a]&&($('input[name="include_shipping"]').prop("checked",!1),$('input[name="include_shipping"]').change());init_billing_and_shipping_details()}function init_billing_and_shipping_details(){var a,b=$('input[name="include_shipping"]').prop("checked");for(var c in bs_fields)a="",a=bs_fields[c].indexOf("country")>-1?$("#"+bs_fields[c]+" option:selected").data("subtext"):$('input[name="'+bs_fields[c]+'"]').val(),bs_fields[c].indexOf("shipping")>-1&&(b||(a="")),"undefined"==typeof a&&(a=""),a=""!=a?a:"--",$("."+bs_fields[c]).text(a);$("#billing_and_shipping_details").modal("hide")}function record_payment(a){"undefined"!=typeof a&&""!=a&&$("#invoice").load(admin_url+"invoices/record_invoice_payment_ajax/"+a)}function add_item_to_preview(a){$.get(admin_url+"invoice_items/get_item_by_id/"+a,function(a){a.taxname||(a.taxname=""),$('textarea[name="description"]').val(a.description),$('textarea[name="long_description"]').val(a.long_description.replace(/(<|&lt;)br\s*\/*(>|&gt;)/g," ")),$('input[name="quantity"]').val(1),a.taxname&&a.taxrate&&$(".main select.tax").selectpicker("val",a.taxname+"|"+a.taxrate),a.unit&&$("th.qty").attr("unit",a.unit),$('input[name="rate"]').val(a.rate)},"json")}function add_task_to_preview_as_item(a){$.get(admin_url+"tasks/get_billable_task_data/"+a,function(b){b.taxname=$("select.main-tax").selectpicker("val"),$('textarea[name="description"]').val(b.name),$('textarea[name="long_description"]').val(b.description),$('input[name="quantity"]').val(b.total_hours),$('input[name="rate"]').val(b.hourly_rate),$('input[name="task_id"]').val(a)},"json")}function clear_main_values(a){var b=$("table.items tbody").find("tr:last-child").find("select").selectpicker("val");$('textarea[name="description"]').val(""),$('textarea[name="long_description"]').val(""),$('input[name="quantity"]').val(1),$(".main select.tax").selectpicker("val",b),$('input[name="rate"]').val(""),$('input[name="item-search"]').val(""),$(".item-search .dropdown-menu").html(""),$('input[name="task_id"]').val(""),$("th.qty").removeAttr("unit")}function add_item_to_table(a,b,c,d){"undefined"!=typeof a&&"undefined"!=a||(a=get_main_values());var e="",f="",g=$("body").find("tbody .item").length+1;e+='<tr class="sortable item" data-merge-invoice="'+c+'" data-bill-expense="'+d+'">',e+='<td class="dragger">',isNaN(a.qty)&&(a.qty=1),(""==a.rate||isNaN(a.rate))&&(a.rate=0);var h=a.rate*a.qty;h=accounting.formatNumber(h);var i="newitems["+g+"][taxname][]";$("body").append('<div class="dt-loader"></div>');var j=/<br[^>]*>/gi;return get_taxes_dropdown_template(i,a.taxname).done(function(c){e+='<input type="hidden" class="order" name="newitems['+g+'][order]">',e+="</td>",e+='<td class="bold description"><textarea name="newitems['+g+'][description]" class="form-control" rows="5">'+a.description+"</textarea></td>",e+='<td><textarea name="newitems['+g+'][long_description]" class="form-control item_long_description" rows="5">'+a.long_description.replace(j,"\n")+"</textarea></td>",e+='<td><input type="number" min="0" onblur="calculate_total();" onchange="calculate_total();" data-quantity name="newitems['+g+'][qty]" value="'+a.qty+'" class="form-control">',f="",a.unit&&"undefined"!=typeof a.unit||(f=lang_unit,a.unit=""),e+='<input type="text" placeholder="'+f+'" name="newitems['+g+'][unit]" class="form-control input-transparent text-right" value="'+a.unit+'">',e+="</td>",e+='<td class="rate"><input type="text" data-toggle="tooltip" title="'+item_field_not_formated+'" onblur="calculate_total();" onchange="calculate_total();" name="newitems['+g+'][rate]" value="'+a.rate+'" class="form-control"></td>',e+='<td class="taxrate">'+c+"</td>",e+='<td class="amount">'+h+"</td>",e+='<td><a href="#" class="btn btn-danger pull-left" onclick="delete_item(this,'+b+'); return false;"><i class="fa fa-trash"></i></a></td>',e+="</tr>",$.when($("table.items tbody").append(e)).then(calculate_total);var d=$('input[name="task_id"]').val(),i=$('input[name="expense_id"]').val();return""!=d&&"undefined"!=typeof d&&(billed_tasks=d.split(","),$.each(billed_tasks,function(a,b){$("#billed-tasks").append(hidden_input("billed_tasks["+g+"][]",b))})),""!=i&&"undefined"!=typeof i&&(billed_expenses=i.split(","),$.each(billed_expenses,function(a,b){$("#billed-expenses").append(hidden_input("billed_expenses["+g+"][]",b))})),init_selectpicker(),clear_main_values(),reorder_items(),$("body").find(".dt-loader").remove(),$("#item_select").selectpicker("val",""),!0}),!1}function get_taxes_dropdown_template(a,b){jQuery.ajaxSetup({async:!1});var c=$.post(admin_url+"misc/get_taxes_dropdown_template/",{name:a,taxname:b});return jQuery.ajaxSetup({async:!0}),c}function fixHelperTableHelperSortable(a,b){return b.children().each(function(){$(this).width($(this).width())}),b}function init_items_sortable(a){$("body").find(".items tbody").sortable({helper:fixHelperTableHelperSortable,handle:".dragger",placeholder:"ui-placeholder",itemPath:"> tbody",itemSelector:"tr.sortable",items:"tr.sortable",update:function(){"undefined"==typeof a?reorder_items():save_ei_items_order()},sort:function(a,b){var c=$(a.target);if(!/html|body/i.test(c.offsetParent()[0].tagName)){var d=a.pageY-c.offsetParent().offset().top-b.helper.outerHeight(!0)/2;b.helper.css({top:d+"px"})}}})}function save_ei_items_order(){var e,a=$(".table.invoice-items-preview.items tbody tr,.table.estimate-items-preview.items tbody tr"),b=1,c=[];if($(".table.items").hasClass("invoice-items-preview"))e="invoice";else{if(!$(".table.items").hasClass("estimate-items-preview"))return!1;e="estimate"}$.each(a,function(){c.push([$(this).data("item-id"),b]),$(this).find("td.item_no").html(b),b++}),setTimeout(function(){$.post(admin_url+"misc/update_ei_items_order/"+e,{data:c})},50)}function reorder_items(){var a=$(".table.table-main-invoice-edit tbody tr.item,.table.table-main-estimate-edit tbody tr.item"),b=1;$.each(a,function(){$(this).find("input.order").val(b),b++})}function get_main_values(){var a={};return a.description=$('textarea[name="description"]').val(),a.long_description=$('textarea[name="long_description"]').val(),a.qty=$('input[name="quantity"]').val(),a.taxname=$(".main select.tax").selectpicker("val"),a.rate=$('input[name="rate"]').val(),a.unit=$("th.qty").attr("unit"),a}function calculate_total(){var a,b,c,d,e,f,g={},i=0,j=0,k=1;total_discount_calculated=0,rows=$(".table.table-main-invoice-edit tbody tr.item,.table.table-main-estimate-edit tbody tr.item"),adjustment=$('input[name="adjustment"]').val(),discount_area=$("tr#discount_percent"),discount_percent=$('input[name="discount_percent"]').val(),discount_type=$('select[name="discount_type"]').val(),$(".tax-area").remove(),$.each(rows,function(){k=$(this).find("[data-quantity]").val(),""==k&&(k=1,$(this).find("[data-quantity]").val(1)),e=parseFloat($(this).find("td.rate input").val())*k,$(this).find("td.amount").html(accounting.formatNumber(e)),i+=e,d=$(this),c=$(this).find("select.tax").selectpicker("val"),c&&$.each(c,function(c,h){b=d.find('select.tax [value="'+h+'"]').data("taxrate"),a=e/100*b,g.hasOwnProperty(h)?g[h]=g[h]+=a:0!=b&&(f=h.split("|"),tax_row='<tr class="tax-area"><td>'+f[0]+"("+b+'%)</td><td id="tax_id_'+slugify(h)+'"></td></tr>',$(discount_area).after(tax_row),g[h]=a)})}),""!=discount_percent&&"before_tax"==discount_type&&(total_discount_calculated=i*discount_percent/100),$.each(g,function(a,b){""!=discount_percent&&"before_tax"==discount_type&&(total_tax_calculated=b*discount_percent/100,b-=total_tax_calculated),j+=b,b=accounting.formatNumber(b),$("#tax_id_"+slugify(a)).html(b)}),j+=i,""!=discount_percent&&"after_tax"==discount_type&&(total_discount_calculated=j*discount_percent/100),j-=total_discount_calculated,adjustment=parseFloat(adjustment),isNaN(adjustment)||(j+=adjustment),$(".discount_percent").html("-"+accounting.formatNumber(total_discount_calculated)+hidden_input("discount_percent",discount_percent)+hidden_input("discount_total",total_discount_calculated)),$(".adjustment").html(accounting.formatNumber(adjustment)+hidden_input("adjustment",adjustment.toFixed(2))),$(".subtotal").html(i=accounting.formatNumber(i)+hidden_input("subtotal",i.toFixed(2))),$(".total").html(format_money(j)+hidden_input("total",j.toFixed(2)))}function delete_item(a,b){$(a).parents("tr").addClass("animated fadeOut",function(){setTimeout(function(){$(a).parents("tr").remove(),calculate_total()},50)}),$('input[name="isedit"]').length>0&&$("#removed-items").append(hidden_input("removed_items[]",b))}function format_money(a){return"after"===currency_placement?accounting.formatMoney(a,{format:"%v %s"}):accounting.formatMoney(a)}function init_currency_symbol(){"undefined"!=typeof accounting&&(accounting.settings.currency.symbol=$("body").find('.accounting-template select[name="currency"]').find("option:selected").data("subtext"),calculate_total())}function delete_invoice_attachment(a){var b=confirm(confirm_action_prompt);return 0!=b&&void $.get(admin_url+"invoices/delete_attachment/"+a,function(b){1==b&&($("body").find('[data-attachment-id="'+a+'"]').remove(),init_invoice($("body").find('input[name="_attachment_sale_id"]').val()))}).fail(function(a){alert_float("danger",a.responseText)})}function delete_estimate_attachment(a){var b=confirm(confirm_action_prompt);return 0!=b&&void $.get(admin_url+"estimates/delete_attachment/"+a,function(b){if(1==b){$("body").find('[data-attachment-id="'+a+'"]').remove();var c=$("body").find('input[name="_attachment_sale_id"]').val();$("body").hasClass("estimates-pipeline")?estimate_pipeline_open(c):init_estimate(c)}}).fail(function(a){alert_float("danger",a.responseText)})}function delete_proposal_attachment(a){var b=confirm(confirm_action_prompt);return 0!=b&&void $.get(admin_url+"proposals/delete_attachment/"+a,function(b){if(1==b){var c=$("body").find('input[name="_attachment_sale_id"]').val();$("body").find('[data-attachment-id="'+a+'"]').remove(),$("body").hasClass("proposals-pipeline")?proposal_pipeline_open(c):init_proposal(c)}}).fail(function(a){alert_float("danger",a.responseText)})}function init_invoices_total(a){if(0!=$("#invoices_total").length&&(!$("body").hasClass("invoices_total_manual")||"undefined"!=typeof a||$(".invoices-total").hasClass("initialized"))){$(".invoices-total").addClass("initialized");var b=$("._filters._hidden_inputs").find('input[name^="year"]'),c=[];$.each(b,function(){var a=$(this).val();""!=a&&c.push(a)});var d=$("._filters._hidden_inputs").find('input[name^="sale_agent"]'),e=[];$.each(d,function(){var a=$(this).val();""!=a&&e.push(a)});var f=$("._filters._hidden_inputs").find('input[name^="invoice_payments_by_"]'),g=[];$.each(f,function(){var a=$(this).val();""!=a&&g.push(a)});var h=$("body").find('select[name="total_currency"]').val(),i={currency:h,years:c,agents:e,payment_modes:g,init_total:!0},j=$('input[name="project_id"]').val(),k=$('.customer_profile input[name="userid"]').val();"undefined"!=typeof j?i.project_id=j:"undefined"!=typeof k&&(i.customer_id=k),$.post(admin_url+"invoices/get_invoices_total",i).done(function(a){$("#invoices_total").html(a)})}}function init_estimates_total(a){if(0!=$("#estimates_total").length&&(!$("body").hasClass("estimates_total_manual")||"undefined"!=typeof a||$(".estimates-total").hasClass("initialized"))){$(".estimates-total").addClass("initialized");var b=$("body").find('select[name="total_currency"]').val(),c=$("._filters._hidden_inputs").find('input[name^="year"]'),d=[];$.each(c,function(){var a=$(this).val();""!=a&&d.push(a)});var e=$("._filters._hidden_inputs").find('input[name^="sale_agent"]'),f=[];$.each(e,function(){var a=$(this).val();""!=a&&f.push(a)});var g="",h="",i=$('.customer_profile input[name="userid"]').val(),j=$('input[name="project_id"]').val();"undefined"!=typeof i?g=i:"undefined"!=typeof j&&(h=j),$.post(admin_url+"estimates/get_estimates_total",{currency:b,init_total:!0,years:d,agents:f,customer_id:g,project_id:h}).done(function(a){$("#estimates_total").html(a)})}}function init_expenses_total(){if(0!=$("#expenses_total").length){var a,b=$('select[name="expenses_total_currency"]').val(),c=$("._filters._hidden_inputs").find('input[name^="year"]'),d=[];$.each(c,function(){a=$(this).val(),""!=a&&d.push(a)});var e=$("._filters._hidden_inputs").find('input[name^="expenses_by_month_"]'),f=[];$.each(e,function(){a=$(this).val(),""!=a&&f.push(a)});var g=$("._filters._hidden_inputs").find('input[name^="expenses_by_category_"]'),h=[];$.each(g,function(){a=$(this).val(),""!=a&&h.push(a)});var i="",j=$('.customer_profile input[name="userid"]').val();"undefined"!=typeof i&&(i=j);var k="",l=$('input[name="project_id"]').val();"undefined"!=typeof k&&(k=l),$.post(admin_url+"expenses/get_expenses_total",{currency:b,init_total:!0,months:f,years:d,categories:h,customer_id:i,project_id:k}).done(function(a){$("#expenses_total").html(a)})}}function validate_invoice_form(a){"undefined"==typeof a&&(a="#invoice-form"),_validate_form($(a),{clientid:"required",date:"required",currency:"required",number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"invoices/validate_invoice_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $('input[name="date"]').val()}}},messages:{remote:invoice_number_exists}})}function validate_estimate_form(a){"undefined"==typeof a&&(a="#estimate-form"),_validate_form($(a),{clientid:"required",date:"required",currency:"required",number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"estimates/validate_estimate_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $('input[name="date"]').val()}}},messages:{remote:estimate_number_exists}})}function estimates_pipeline_sort(a){var b=$('input[name="sort"]');$('input[name="sort_type"]').val(a),"ASC"==b.val()?b.val("DESC"):"DESC"==b.val()?b.val("ASC"):b.val("DESC"),estimate_pipeline()}function proposal_pipeline_sort(a){var b=$('input[name="sort"]');$('input[name="sort_type"]').val(a),"ASC"==b.val()?b.val("DESC"):"DESC"==b.val()?b.val("ASC"):b.val("DESC"),proposals_pipeline()}function estimate_pipeline(){init_kanban("estimates/get_pipeline",estimates_pipeline_update,".pipeline-status",310,360)}function estimates_pipeline_update(a,b){if(b===a.item.parent()[0]){var c={};c.estimateid=$(a.item).data("estimate-id"),c.status=$(a.item.parent()[0]).data("status-id");var d=[],e=$(a.item).parents(".pipeline-status").find("li"),f=1;$.each(e,function(){d.push([$(this).data("estimate-id"),f]),f++}),c.order=d,check_kanban_empty_col("[data-estimate-id]"),$.post(admin_url+"estimates/update_pipeline",c)}}function proposals_pipeline_update(a,b){if(b===a.item.parent()[0]){var c={};c.proposalid=$(a.item).data("proposal-id"),c.status=$(a.item.parent()[0]).data("status-id");var d=[],e=$(a.item).parents(".pipeline-status").find("li"),f=1;$.each(e,function(){d.push([$(this).data("proposal-id"),f]),f++}),c.order=d,check_kanban_empty_col("[data-proposal-id]"),$.post(admin_url+"proposals/update_pipeline",c)}}function proposals_pipeline(){init_kanban("proposals/get_pipeline",proposals_pipeline_update,".pipeline-status",310,360)}function proposal_pipeline_open(a){""!=a&&$.get(admin_url+"proposals/pipeline_open/"+a,function(a){var b=$(".proposal-pipeline-modal:visible").length;$("#proposal").html(a),0==b?$(".proposal-pipeline-modal").modal({show:!0,backdrop:"static",keyboard:!1}):$("#proposal").find(".modal.proposal-pipeline-modal").addClass("in").css("display","block")})}function estimate_pipeline_open(a){""!=a&&$.get(admin_url+"estimates/pipeline_open/"+a,function(a){var b=$(".estimate-pipeline:visible").length;$("#estimate").html(a),0==b?$(".estimate-pipeline").modal({show:!0,backdrop:"static",keyboard:!1}):$("#estimate").find(".modal.estimate-pipeline").addClass("in").css("display","block")})}function delete_estimate_note(a,b){var c=confirm(confirm_action_prompt);return 0!=c&&void $.get(admin_url+"estimates/delete_note/"+b,function(b){1==b.success&&$(a).parents(".estimate-note").remove()},"json")}function get_estimate_notes(a){$.get(admin_url+"estimates/get_notes/"+a,function(a){$("#estimate_notes_area").html(a)})}function insert_proposal_merge_field(a){var b=$(a).text();tinymce.activeEditor.execCommand("mceInsertContent",!1,b)}function small_table_full_view(){$("#small-table").toggleClass("hide"),$(".small-table-right-col").toggleClass("col-md-12"),$(".small-table-right-col").toggleClass("col-md-7")}function manage_invoice_items(a){var b=$(a).serialize(),c=a.action;return $.post(c,b).done(function(a){if(a=JSON.parse(a),1==a.success){var b=$("#item_select");if($("body").find(".accounting-template").length>0){var c=b.find('[data-group-id="'+a.item.group_id+'"]'),d='<option data-subtext="'+a.item.long_description+'" value="'+a.item.itemid+'">('+accounting.formatNumber(a.item.rate)+") "+a.item.description+"</option>";0==c.length?(d='<optgroup label="'+(null==a.item.group_name?"":a.item.group_name)+'" data-group-id="'+a.item.group_id+'">'+d+"</optgroup>",0==b.find('[data-group-id="0"]').length?b.find("option:first-child").after(d):b.find('[data-group-id="0"]').after(d)):c.prepend(d),b.selectpicker("refresh"),add_item_to_preview(a.item.itemid)}else $(".table-invoice-items").DataTable().ajax.reload();alert_float("success",a.message)}$("#sales_item_modal").modal("hide")}).fail(function(a){alert_float("danger",a.responseText)}),!1}function save_sales_number_settings(a){var b={};b.prefix=$("body").find('input[name="s_prefix"]').val(),""!=b.prefix&&$.post($(a).data("url"),b).done(function(a){a=JSON.parse(a),a.success&&a.message&&(alert_float("success",a.message),$("#prefix").html(b.prefix))})}function do_prefix_year(a){var b;a.indexOf(".")>-1?b=a.split("."):a.indexOf("-")>-1?b=a.split("-"):a.indexOf("/")>-1&&(b=a.split("/")),"undefined"!=typeof b&&$.each(b,function(a,b){4==b.length&&$("#prefix_year").html(b)})}function delete_sale_activity(a){var b=confirm(confirm_action_prompt);return 0!=b&&void $.get(admin_url+"misc/delete_sale_activity/"+a,function(){$("body").find('[data-sale-activity-id="'+a+'"]').remove()})}Dropzone.options.salesUpload=!1,$(function(){if(init_invoices_total(),init_expenses_total(),init_estimates_total(),init_items_sortable(),$("body").hasClass("estimates-pipeline")){var a=$('input[name="estimateid"]').val();estimate_pipeline_open(a)}if($("body").hasClass("proposals-pipeline")){var b=$('input[name="proposalid"]').val();proposal_pipeline_open(b)}$("body").on("submit","._transaction_form",function(){return calculate_total(),reorder_items(),$('select[name="currency"]').prop("disabled",!1),$('select[name="project_id"]').prop("disabled",!1),!0}),$("body").on("click",".invoice-form-submit",function(){var a=$(".invoice-form");a.valid()&&($(this).hasClass("save-as-draft")?a.find(".additional").html(hidden_input("save_as_draft","true")):a.find(".additional").html(""),a.submit())}),$("body").on("change",'[name="recurring"]',function(){var a=$(this).val();0!=a?("custom"==a?$(".recurring_custom").removeClass("hide"):$(".recurring_custom").addClass("hide"),$("body").find("#recurring_ends_on").removeClass("hide")):($("body").find("#recurring_ends_on").addClass("hide"),$("body").find("#recurring_ends_on input").val(""),$(".recurring_custom").addClass("hide"))}),$("body").on("submit","#estimate-notes",function(){var a=$("#estimate-notes");if(""!=a.find('textarea[name="description"]').val()){var b=$(this),c=$(b).serialize();return $.post(b.attr("action"),c).done(function(b){get_estimate_notes(b),a.find('textarea[name="description"]').val("")}),!1}}),$("body").on("change",'input[name="show_quantity_as"]',function(){$("body").find("th.qty").html($(this).data("text"))}),$("body").on("change",'div.estimate input[name="date"]',function(){do_prefix_year($(this).val())}),$("body").on("change",'div.invoice input[name="date"]',function(){var a=$(this).val();do_prefix_year(a),$('input[name="isedit"]').length>0||(""!=a?$.post(admin_url+"invoices/get_due_date",{date:a}).done(function(a){$('input[name="duedate"]').val(a)}):$('input[name="duedate"]').val(""))}),$("#sales_attach_file").on("hidden.bs.modal",function(a){$("#sales_uploaded_files_preview").empty(),$(".dz-file-preview").empty()}),"undefined"!=typeof Dropbox&&$("#dropbox-chooser-sales").length>0&&document.getElementById("dropbox-chooser-sales").appendChild(Dropbox.createChooseButton({success:function(a){var b={};b.rel_id=$("body").find('input[name="_attachment_sale_id"]').val(),b.type=$("body").find('input[name="_attachment_sale_type"]').val(),b.files=a,b.external="dropbox",$.post(admin_url+"misc/add_sales_external_attachment",b).done(function(){"invoice"==b.type?init_invoice(b.rel_id):"estimate"==b.type?$("body").hasClass("estimates-pipeline")?estimate_pipeline_open(b.rel_id):init_estimate(b.rel_id):"proposal"==b.type&&($("body").hasClass("proposals-pipeline")?proposal_pipeline_open(b.rel_id):init_proposal(b.rel_id)),$("#sales_attach_file").modal("hide")})},linkType:"preview",extensions:allowed_files.split(",")})),$("#sales-upload").length>0&&new Dropzone("#sales-upload",{createImageThumbnails:!1,dictFileTooBig:file_exceds_maxfile_size_in_form,sending:function(a,b,c){c.append("rel_id",$("body").find('input[name="_attachment_sale_id"]').val()),c.append("type",$("body").find('input[name="_attachment_sale_type"]').val())},complete:function(a){this.removeFile(a)},success:function(a,b){b=JSON.parse(b);var d,e,c=$("body").find('input[name="_attachment_sale_type"]').val();d="download/file/sales_attachment/",e="delete_"+c+"_attachment","invoice"==c?init_invoice(b.rel_id):"estimate"==c?$("body").hasClass("estimates-pipeline")?estimate_pipeline_open(b.rel_id):init_estimate(b.rel_id):"proposal"==c&&($("body").hasClass("proposals-pipeline")?proposal_pipeline_open(b.rel_id):init_proposal(b.rel_id));var f="";1==b.success&&(f+='<div class="display-block" data-attachment-id="'+b.attachment_id+'">',f+='<div class="col-md-10">',f+='<div class="pull-left"><i class="attachment-icon-preview fa fa-file-o"></i></div>',f+='<a href="'+site_url+d+b.key+'" target="_blank">'+b.file_name+"</a>",f+='<p class="text-muted">'+b.filetype+"</p>",f+="</div>",f+='<div class="col-md-2 text-right">',f+='<a href="#" class="text-danger" onclick="'+e+"("+b.attachment_id+'); return false;"><i class="fa fa-times"></i></a>',f+="</div>",f+='<div class="clearfix"></div><hr/>',f+="</div>",$("#sales_uploaded_files_preview").append(f))},maxFilesize:max_php_ini_upload_size.replace(/\D/g,""),acceptedFiles:allowed_files,error:function(a,b){alert_float("danger",b)}}),$("#invoice_attach").on("hidden.bs.modal",function(a){$(".dz-preview").remove(),$(".invoice-attach-dropzone-preview").remove()}),$("body").on("show.bs.modal","#sales_item_modal",function(a){_validate_form($("#invoice_item_form"),{description:"required",rate:{required:!0}},manage_invoice_items),$(".affect-warning").addClass("hide");var b=$(a.relatedTarget),c=b.data("id");$("#sales_item_modal input").val(""),$("#sales_item_modal textarea").val(""),$("#sales_item_modal #group_id").selectpicker("val",""),$('select[name="tax"]').selectpicker("deselectAll"),$("#sales_item_modal .add-title").removeClass("hide"),$("#sales_item_modal .edit-title").addClass("hide"),"undefined"!=typeof c&&($(".affect-warning").removeClass("hide"),$('input[name="itemid"]').val(c),$("#sales_item_modal .add-title").addClass("hide"),$("#sales_item_modal .edit-title").removeClass("hide"),$('#sales_item_modal input[name="description"]').val($(b).parents("tr").find("td").eq(0).text()),$('#sales_item_modal input[name="rate"]').val($(b).parents("tr").find("td").eq(2).text()),$('#sales_item_modal input[name="unit"]').val($(b).parents("tr").find("td").eq(4).text()),$("#sales_item_modal textarea").val($(b).parents("tr").find("td").eq(1).text()),$("#sales_item_modal #group_id").selectpicker("val",b.attr("data-group-id")),$('select[name="tax"]').selectpicker("val",$(b).parents("tr").find("td").eq(3).find("span").data("taxid")))}),$("body").on("hidden.bs.modal","#sales_item_modal",function(a){$("#item_select").selectpicker("val","")}),$("body").on("click",".invoice-send-to-client",function(a){a.preventDefault(),$("#invoice_send_to_client_modal").modal("show")}),$("body").on("click",".estimate-send-to-client",function(a){a.preventDefault(),$("#estimate_send_to_client_modal").modal("show")}),$("body").on("click",".close-send-template-modal",function(){$("#estimate_send_to_client_modal").modal("hide"),$("#proposal_send_to_customer").modal("hide")}),$("body").on("change","#include_shipping",function(){1==$(this).prop("checked")?$("#shipping_details").removeClass("hide"):$("#shipping_details").addClass("hide")}),$("body").on("click",".save-shipping-billing",function(a){init_billing_and_shipping_details()}),$("body").on("change",'select[name="currency"]',function(){init_currency_symbol()}),$("body").on("change","select.tax",function(){var a=$(this).val();null!=a&&a.indexOf("")>-1&&a.length>1&&(a.splice(0,1),$(this).selectpicker("val",a))}),$("body").on("change",'input[name="adjustment"],select.tax',function(){calculate_total()}),$("body").on("change",'select[name="discount_type"]',function(){""==$(this).val()&&$('input[name="discount_percent"]').val(0),calculate_total()}),$("body").on("change",'input[name="discount_percent"]',function(){return""==$('select[name="discount_type"]').val()&&0!=$(this).val()?(alert("Select discount type"),$(this).val(0),$("html,body").animate({scrollTop:0},"slow"),$("#wrapper").highlight($('label[for="discount_type"]').text()),setTimeout(function(){$("#wrapper").unhighlight()},3e3),!1):void(1==$(this).valid()&&calculate_total())}),$("body").on("change",'select[name="item_select"]',function(){var a=$(this).selectpicker("val");""!=a&&"newitem"!==a?add_item_to_preview(a):"newitem"==a&&$("#sales_item_modal").modal("show")}),$("body").on("change",'select[name="task_select"]',function(){var a=$(this).selectpicker("val");""!=a&&add_task_to_preview_as_item(a)}),$("body").on("change",'select[name="paymentmode"]',function(){$.isNumeric($(this).val())?$(".do_not_redirect").addClass("hide"):$(".do_not_redirect").removeClass("hide")}),$("body").on("change",'.f_client_id select[name="clientid"]',function(){var a=$(this).val(),b=$('select[name="project_id"]');if(b.empty(),clear_billing_and_shipping_details(),""==a)return $("#merge").empty(),$("#expenses_to_bill").empty(),b.selectpicker("refresh"),$(".projects-wrapper").addClass("hide"),!1;var c=$("body").find('input[name="merge_current_invoice"]').val();$.get(admin_url+"invoices/client_change_data/"+a+"/"+c,function(a){$("#merge").html(a.merge_info),$("#expenses_to_bill").html(a.expenses_bill_info),""!=a.merge_info||""!=a.expenses_bill_info?$("#invoice_top_info").removeClass("hide"):$("#invoice_top_info").addClass("hide");for(var c in bs_fields)bs_fields[c].indexOf("billing")>-1&&(bs_fields[c].indexOf("country")>-1?$('select[name="'+bs_fields[c]+'"]').selectpicker("val",a.billing_shipping[0][bs_fields[c]]):$('input[name="'+bs_fields[c]+'"]').val(a.billing_shipping[0][bs_fields[c]]));empty(a.billing_shipping[0].shipping_street)||($('input[name="include_shipping"]').prop("checked",!0),$('input[name="include_shipping"]').change());for(var c in bs_fields)bs_fields[c].indexOf("shipping")>-1&&(bs_fields[c].indexOf("country")>-1?$('select[name="'+bs_fields[c]+'"]').selectpicker("val",a.billing_shipping[0][bs_fields[c]]):$('input[name="'+bs_fields[c]+'"]').val(a.billing_shipping[0][bs_fields[c]]));init_billing_and_shipping_details();var d=a.client_currency,e=$("body").find('.accounting-template select[name="currency"]');d=parseInt(d),0!=d?e.val(d):e.val(e.data("base"));var f=$("#task_select");if(f.length>0){var g;f.find("option").filter(function(){return this.value||$.trim(this.value).length>0||$.trim(this.text).length>0}).remove(),$.each(a.billable_tasks,function(a,b){g=" ",g+=1==b.started_timers?'disabled class="text-danger important" data-subtext="'+invoice_task_billable_timers_found+'"':'data-subtext="'+b.rel_name+'"',f.append('<option value="'+b.id+'"'+g+">"+b.name+"</option>")}),f.selectpicker("refresh")}a.projects.length>0?($(".projects-wrapper").removeClass("hide"),b.append('<option value=""></option>'),$.each(a.projects,function(a,c){b.append('<option value="'+c.id+'">'+c.name+"</option>")})):$(".projects-wrapper").addClass("hide"),b.selectpicker("refresh"),e.selectpicker("refresh"),init_currency_symbol()},"json")}),0==$('input[name="isedit"]').length&&$('.f_client_id select[name="clientid"]').change(),$("body").on("click","#get_shipping_from_customer_profile",function(a){a.preventDefault();var b=$("#include_shipping");0==b.prop("checked")&&(b.prop("checked",!0),$("#shipping_details").removeClass("hide"));var c=$('select[name="clientid"]').val();""!=c&&$.get(admin_url+"clients/get_customer_billing_and_shipping_details/"+c,function(a){$('input[name="shipping_street"]').val(a[0].shipping_street),$('input[name="shipping_city"]').val(a[0].shipping_city),$('input[name="shipping_state"]').val(a[0].shipping_state),$('input[name="shipping_zip"]').val(a[0].shipping_zip),$('select[name="shipping_country"]').selectpicker("val",a[0].shipping_country)},"json")}),"undefined"!=typeof accounting&&(accounting.settings.currency.decimal=decimal_separator,accounting.settings.currency.thousand=thousand_separator,accounting.settings.number.thousand=thousand_separator,accounting.settings.number.decimal=decimal_separator,accounting.settings.number.precision=2,calculate_total()),$("body").on("change",'input[name="invoices_to_merge[]"]',function(){var a=$(this).prop("checked"),b=$(this).val();1==a?$.get(admin_url+"invoices/get_merge_data/"+b,function(a){$.each(a.items,function(a,c){""!=c.rel_type&&("task"==c.rel_type?$('input[name="task_id"]').val(c.item_related_formated_for_input):"expense"==c.rel_type&&$('input[name="expense_id"]').val(c.item_related_formated_for_input)),add_item_to_table(c,"undefined",b)})},"json"):$("body").find('[data-merge-invoice="'+b+'"]').remove();
}),$("body").on("change",'input[name="bill_expenses[]"]',function(){var a=$(this).prop("checked"),b=$(this).val();1==a?$.get(admin_url+"invoices/get_bill_expense_data/"+b,function(a){$('input[name="expense_id"]').val(b),add_item_to_table(a,"undefined","undefined",b)},"json"):($("body").find('[data-bill-expense="'+b+'"]').remove(),$("body").find('#billed-expenses input[value="'+b+'"]').remove())}),$("body").on("change",".invoice_inc_expense_additional_info input",function(){var b,a=$(this).attr("data-content"),c=$("[data-bill-expense="+$(this).attr("data-id")+"] .item_long_description");current_desc_val=c.val(),current_desc_val=current_desc_val.trim(),""!=a&&(1==$(this).prop("checked")?(b=current_desc_val+"\n"+a,c.val(b.trim())):(c.val(current_desc_val.replace("\n"+a,"")),c.val(current_desc_val.replace(a,""))))})});
